# Kryon Round-Trip C ‚Üî KIR Conversion

## Overview

Kryon supports bidirectional conversion between C source code and KIR (Kryon Intermediate Representation) format, enabling perfect round-trip transformations where `main.c` ‚Üí `main.kir` ‚Üí `generated_main.c` produces functionally equivalent code.

## Architecture

### Components

1. **C Metadata Capture** (`ir/ir_c_metadata.h`, `bindings/c/kryon.c`)
   - Captures source-level information during C compilation
   - Stores variables, event handlers, includes, and preprocessor directives

2. **KIR Serialization** (`ir/ir_json_v2.c`)
   - Serializes IR and metadata to JSON format (version "1")
   - Preserves all structural and behavioral information

3. **C Code Generator** (`codegens/c/ir_c_codegen.c`)
   - Generates idiomatic C DSL code from KIR
   - Maps KIR components and properties to C macros

### Data Flow

```
C Source (main.c)
    ‚Üì
[C Compiler + Metadata Capture]
    ‚Üì
KIR JSON (main.kir)
    ‚Üì
[C Code Generator]
    ‚Üì
Generated C (generated_main.c)
```

## KIR Format (Version 1)

### Structure

```json
{
  "format_version": "1",
  "c_metadata": {
    "includes": [...],
    "variables": [...],
    "event_handlers": [...],
    "helper_functions": [...],
    "preprocessor_directives": [...],
    "source_files": [...]
  },
  "root": {
    "id": 1,
    "type": "Container",
    "properties": {...},
    "children": [...]
  }
}
```

### C Metadata Schema

#### Includes
```json
{
  "include": "<stdio.h>",
  "is_system": true,
  "line_number": 5
}
```

#### Variables
```json
{
  "name": "title_screen",
  "type": "IRComponent*",
  "storage": "static",
  "initial_value": "NULL",
  "component_id": 3,
  "line_number": 10
}
```

#### Event Handlers
```json
{
  "logic_id": "c_click_6_0",
  "function_name": "on_start_game",
  "return_type": "void",
  "parameters": "void",
  "body": "    kryon_set_visible(title_screen, false);\n    kryon_set_visible(game_screen, true);",
  "line_number": 25
}
```

#### Helper Functions
```json
{
  "name": "calculate_score",
  "return_type": "int",
  "parameters": "int base, float multiplier",
  "body": "return (int)(base * multiplier);",
  "line_number": 15
}
```

#### Preprocessor Directives
```json
{
  "type": "define",
  "content": "MAX_PLAYERS 4",
  "line_number": 3
}
```

## C Code Generation

### Component Mapping

| KIR Type | C Macro |
|----------|---------|
| Container | `CONTAINER(...)` |
| Column | `COLUMN(...)` |
| Row | `ROW(...)` |
| Text | `TEXT("label", ...)` |
| Button | `BUTTON("label", ...)` |

### Property Mapping

| KIR Property | C Macro |
|--------------|---------|
| `width: "100.0px"` | `FULL_WIDTH` |
| `height: "100.0px"` | `FULL_HEIGHT` |
| `background: "#6366f1"` | `BG_COLOR("#6366f1")` |
| `color: "#ffffff"` | `COLOR_WHITE` |
| `fontSize: 24` | `FONT_SIZE(24)` |
| `fontBold: true` | `FONT_BOLD` |
| `padding: 20` | `PADDING(20)` |
| `gap: 10` | `GAP(10)` |
| `visible: false` | `VISIBLE(false)` |
| `justifyContent: "center"` | `JUSTIFY_CENTER` |
| `alignItems: "center"` | `ALIGN_CENTER` |
| `flexShrink: 0` | `FLEX_SHRINK(0)` |

### Generated Code Structure

```c
/**
 * Auto-generated C code from .kir file
 * Generated by Kryon C Code Generator
 */

#include <kryon.h>
#include <kryon_dsl.h>
#include <stdio.h>
#include <stdbool.h>

// Generated variable declarations
static IRComponent* title_screen = NULL;
static IRComponent* game_screen = NULL;

// Generated event handlers
void on_start_game(void) {
    kryon_set_visible(title_screen, false);
    kryon_set_visible(game_screen, true);
}

// Generated helper functions
int calculate_score(int base, float multiplier) {
    return (int)(base * multiplier);
}

int main(void) {
    kryon_init("My App", 800, 600);

    KRYON_APP(
        COLUMN(
            FULL_WIDTH,
            FULL_HEIGHT,
            BG_COLOR("#0a0e27"),

            title_screen = COLUMN(
                FULL_SIZE,
                PADDING(60),

                TEXT("KATALIS",
                    FONT_SIZE(72),
                    FONT_BOLD,
                    COLOR_YELLOW
                ),

                BUTTON("Start Game",
                    BG_COLOR("#6366f1"),
                    COLOR_WHITE,
                    ON_CLICK(on_start_game)
                )
            ),

            game_screen = COLUMN(
                FULL_SIZE,
                VISIBLE(false),
                PADDING(40),

                TEXT("Game Screen",
                    FONT_SIZE(48),
                    COLOR_WHITE
                )
            )
        )
    );

    KRYON_RUN();
}
```

## Usage

### C ‚Üí KIR Conversion

```bash
# Compile C source to KIR
kryon run main.c

# Output: .kryon_cache/main.kir
```

### KIR ‚Üí C Conversion

```bash
# Generate C code from KIR
kryon codegen c input.kir output.c

# Compile the generated code
gcc output.c -o app -lkryon_desktop
```

### Full Round-Trip

```bash
# Start with C source
kryon run main.c                      # ‚Üí main.kir

# Generate back to C
kryon codegen c .kryon_cache/main.kir generated_main.c

# Verify equivalence
diff main.c generated_main.c
```

## Implementation Status

### ‚úÖ Completed

- [x] C metadata structure definitions (`ir_c_metadata.h`)
- [x] Metadata serialization to KIR v1 (`ir_json_v2.c`)
- [x] JSON format version changed to "1"
- [x] C code generator implementation (`ir_c_codegen.c`)
- [x] Component tree generation with proper nesting
- [x] Property mapping to C DSL macros
- [x] Comma and formatting handling
- [x] Include generation
- [x] Variable declaration generation (when metadata present)
- [x] Event handler generation (when metadata present)
- [x] Helper function generation (when metadata present)

### üöß Partial / Not Yet Implemented

- [ ] Automatic variable name capture in C frontend
- [ ] Automatic event handler body capture
- [ ] Preprocessor directive serialization
- [ ] Source file content preservation
- [ ] ON_CLICK macro generation (requires event handler metadata)
- [ ] Variable assignment in component tree (requires variable metadata)

### ‚ö†Ô∏è Known Limitations

1. **Comments are not preserved** (by design - acceptable loss)
2. **Variable names** must be manually tracked via metadata API (not automatic)
3. **Event handler bodies** must be explicitly registered (no automatic parsing)
4. **Formatting differences** - generated code may have different whitespace
5. **Local variables** within event handlers are not preserved
6. **Complex C expressions** may need simplification

## Metadata Capture API

For applications that need to preserve variable names and event handlers in round-trip conversion:

```c
#include <kryon.h>

// Register a variable declaration
kryon_register_variable(
    "my_component",      // name
    "IRComponent*",      // type
    "static",            // storage class
    "NULL",              // initial value
    component_id         // component ID
);

// Register an event handler
kryon_register_event_handler(
    "c_click_6_0",       // logic_id
    "on_button_click",   // function_name
    "void",              // return_type
    "void",              // parameters
    "printf(\"Clicked\");"  // body
);

// Register an include
kryon_add_include("<stdio.h>");     // system include
kryon_add_include("\"myheader.h\""); // user include

// Set window configuration
kryon_set_window_config("My App", 800, 600);
```

## Testing

### Test Round-Trip Conversion

```bash
# Create a simple test case
cat > test.c << 'EOF'
#include <kryon.h>
#include <kryon_dsl.h>

int main(void) {
    kryon_init("Test", 800, 600);
    KRYON_APP(
        TEXT("Hello World",
            FONT_SIZE(24),
            COLOR_WHITE
        )
    );
    KRYON_RUN();
}
EOF

# Run round-trip
kryon run test.c
kryon codegen c .kryon_cache/test.kir generated_test.c

# Verify syntax
gcc -fsyntax-only generated_test.c -I$HOME/.local/include

# Compare
diff test.c generated_test.c
```

## Future Enhancements

### Planned Features

1. **Automatic Variable Capture** - Detect variable assignments via macro expansion
2. **Source-Level Parsing** - Parse C source to extract function bodies automatically
3. **Multi-File Support** - Handle projects with multiple source files
4. **Preprocessor Preservation** - Maintain #define, #ifdef, etc.
5. **Comment Preservation** - Optional comment retention via special markers
6. **Validation Tool** - Verify round-trip equivalence automatically

### Extension Points

- Custom property mappings via plugin system
- Custom component type generators
- Alternative output formats (C++, Rust bindings)
- Optimization passes (dead code elimination, constant folding)

## Technical Details

### Code Generator Implementation

The C code generator (`ir_c_codegen.c`) uses a recursive descent approach:

1. **Context Initialization**
   - Load KIR JSON
   - Extract metadata sections
   - Initialize output file

2. **Header Generation**
   - Comment header
   - Includes (system first, then user)
   - Preprocessor directives

3. **Declaration Generation**
   - Variable declarations (static, extern, auto)
   - Helper function prototypes/definitions
   - Event handler definitions

4. **Main Function Generation**
   - `kryon_init()` call
   - `KRYON_APP()` macro with component tree
   - `KRYON_RUN()` call

5. **Component Tree Recursion**
   - Map component type to macro name
   - Generate text/label parameter
   - Generate properties with comma handling
   - Recursively generate children
   - Proper indentation tracking

### Comma Handling

Properties are printed with commas between them using a buffering strategy:

- Skip properties that won't generate output (e.g., events without handlers)
- Print comma before each property except the first
- Separate property blocks from children blocks with blank line

### Indentation Tracking

The generator maintains an `indent_level` counter:

- Increment when entering a component
- Decrement when closing a component
- Each level = 4 spaces

## Contributing

To extend the round-trip conversion system:

1. Add new property mappings in `generate_property_macro()`
2. Add new component types in `get_component_macro()`
3. Extend metadata structures in `ir_c_metadata.h`
4. Update serialization in `ir_json_v2.c`
5. Add tests in `tests/roundtrip/`

## References

- [Kryon IR Documentation](./IR_SPECIFICATION.md)
- [C DSL Reference](../bindings/c/README.md)
- [Code Generator Source](../codegens/c/ir_c_codegen.c)
- [Metadata Header](../ir/ir_c_metadata.h)
