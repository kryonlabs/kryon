/**
 * Run Command
 * Executes source files or KIR files using C backend
 */

#include "kryon_cli.h"
#include "../../ir/ir_core.h"
#include "../../ir/ir_serialization.h"
#include "../../backends/desktop/ir_desktop_renderer.h"
#include <stdio.h>
#include <stdlib.h>
#include <string.h>

static const char* detect_frontend(const char* file) {
    const char* ext = path_extension(file);

    if (strcmp(ext, ".kry") == 0) return "kry";
    else if (strcmp(ext, ".kir") == 0) return "kir";
    else if (strcmp(ext, ".md") == 0) return "markdown";
    else if (strcmp(ext, ".html") == 0) return "html";
    else if (strcmp(ext, ".tsx") == 0 || strcmp(ext, ".jsx") == 0) return "tsx";
    else if (strcmp(ext, ".c") == 0 || strcmp(ext, ".h") == 0) return "c";
    else if (strcmp(ext, ".lua") == 0) return "lua";
    else return NULL;
}

int cmd_run(int argc, char** argv) {
    const char* target_file = NULL;
    bool free_target = false;

    // If no file specified, use entry from config
    if (argc < 1) {
        KryonConfig* config = config_find_and_load();
        if (!config) {
            fprintf(stderr, "Error: No file specified and no kryon.toml found\n\n");
            fprintf(stderr, "Usage: kryon run <file>\n\n");
            fprintf(stderr, "Supported file types:\n");
            fprintf(stderr, "  .kry        - Kryon DSL\n");
            fprintf(stderr, "  .kir        - Kryon IR (compiled)\n");
            fprintf(stderr, "  .md         - Markdown documents\n");
            fprintf(stderr, "  .tsx, .jsx  - TypeScript/JavaScript with JSX\n");
            fprintf(stderr, "  .lua        - Lua with Kryon API\n");
            return 1;
        }

        if (!config->build_entry) {
            fprintf(stderr, "Error: No file specified and no build.entry in kryon.toml\n\n");
            fprintf(stderr, "Add to your kryon.toml:\n");
            fprintf(stderr, "  [build]\n");
            fprintf(stderr, "  entry = \"your-file.kry\"\n\n");
            fprintf(stderr, "Or run with a file:\n");
            fprintf(stderr, "  kryon run <file>\n");
            config_free(config);
            return 1;
        }

        target_file = str_copy(config->build_entry);
        free_target = true;
        config_free(config);
    } else {
        target_file = argv[0];
    }

    // Check if file exists
    if (!file_exists(target_file)) {
        fprintf(stderr, "Error: File not found: %s\n", target_file);
        if (free_target) free((char*)target_file);
        return 1;
    }

    // Detect frontend and validate BEFORE printing "Running"
    const char* frontend = detect_frontend(target_file);
    if (!frontend) {
        const char* ext = path_extension(target_file);
        fprintf(stderr, "Error: Unsupported file type: %s\n\n", ext);
        fprintf(stderr, "Supported INPUT formats:\n");
        fprintf(stderr, "  .kry        - Kryon DSL\n");
        fprintf(stderr, "  .kir        - Kryon IR (compiled)\n");
        fprintf(stderr, "  .md         - Markdown documents\n");
        fprintf(stderr, "  .html       - HTML documents\n");
        fprintf(stderr, "  .tsx, .jsx  - TypeScript/JavaScript with JSX\n");
        fprintf(stderr, "  .c, .h      - C source with Kryon API\n");
        fprintf(stderr, "  .lua        - Lua with Kryon API\n");
        fprintf(stderr, "\nNote: .nim is an OUTPUT format (generated by codegen)\n");
        fprintf(stderr, "Use: kryon codegen <lang> <input.kir> <output>\n");
        if (free_target) free((char*)target_file);
        return 1;
    }

    printf("Running: %s\n", target_file);

    // Get the path to the desktop renderer library
    const char* desktop_lib = getenv("KRYON_DESKTOP_LIB");
    if (!desktop_lib) {
        // Try default locations
        if (file_exists("/home/wao/.local/lib/libkryon_desktop.so")) {
            desktop_lib = "/home/wao/.local/lib/libkryon_desktop.so";
        } else if (file_exists("/mnt/storage/Projects/kryon/build/libkryon_desktop.so")) {
            desktop_lib = "/mnt/storage/Projects/kryon/build/libkryon_desktop.so";
        } else {
            fprintf(stderr, "Error: Desktop renderer library not found\n");
            fprintf(stderr, "Please run: make install\n");
            fprintf(stderr, "Or set KRYON_DESKTOP_LIB environment variable\n");
            if (free_target) free((char*)target_file);
            return 1;
        }
    }

    // Build command to run the file
    char cmd[4096];

    if (strcmp(frontend, "kir") == 0) {
        // Run KIR file directly
        snprintf(cmd, sizeof(cmd),
                 "LD_LIBRARY_PATH=/home/wao/.local/lib:\"/mnt/storage/Projects/kryon/build\":$LD_LIBRARY_PATH "
                 "KRYON_LIB_PATH=\"%s\" "
                 "%s \"%s\"",
                 desktop_lib, desktop_lib, target_file);
    } else {
        // AUTO-COMPILE ANY FORMAT TO KIR FIRST

        // Extract basename from target_file
        const char* basename = strrchr(target_file, '/');
        basename = basename ? basename + 1 : target_file;

        // Create KIR filename
        char kir_file[1024];
        snprintf(kir_file, sizeof(kir_file), ".kryon_cache/%s", basename);

        // Change extension to .kir
        char* dot = strrchr(kir_file, '.');
        if (dot) {
            strcpy(dot, ".kir");
        }

        // Compile to KIR (works for ALL formats now: .kry, .md, .html, .tsx, .lua, .c)
        printf("Compiling %s...\n", target_file);
        char compile_cmd[2048];
        snprintf(compile_cmd, sizeof(compile_cmd),
                 "kryon compile \"%s\" 2>&1", target_file);

        int compile_result = system(compile_cmd);
        if (compile_result != 0) {
            fprintf(stderr, "Error: Failed to compile %s\n", target_file);
            if (free_target) free((char*)target_file);
            return 1;
        }

        // Now execute the compiled KIR
        printf("âœ“ Compiled to KIR: %s\n", kir_file);

        // Load the KIR file
        fprintf(stderr, "[DEBUG] Loading KIR file: %s\n", kir_file);
        IRComponent* root = ir_read_json_file(kir_file);
        if (!root) {
            fprintf(stderr, "Error: Failed to load KIR file: %s\n", kir_file);
            if (free_target) free((char*)target_file);
            return 1;
        }
        fprintf(stderr, "[DEBUG] KIR file loaded successfully\n");

        // Create desktop renderer config with defaults
        int window_width = 800;
        int window_height = 600;
        const char* window_title = "Kryon App";

        // Override with window properties from IR metadata if available
        extern IRContext* g_ir_context;
        fprintf(stderr, "[DEBUG] Checking IR context for window properties\n");
        if (g_ir_context) {
            fprintf(stderr, "[DEBUG] IR context exists\n");
            if (g_ir_context->metadata) {
                fprintf(stderr, "[DEBUG] Metadata exists\n");
                if (g_ir_context->metadata->window_width > 0) {
                    window_width = g_ir_context->metadata->window_width;
                    fprintf(stderr, "[DEBUG] Using window width: %d\n", window_width);
                }
                if (g_ir_context->metadata->window_height > 0) {
                    window_height = g_ir_context->metadata->window_height;
                    fprintf(stderr, "[DEBUG] Using window height: %d\n", window_height);
                }
                if (g_ir_context->metadata->window_title) {
                    window_title = g_ir_context->metadata->window_title;
                    fprintf(stderr, "[DEBUG] Using window title: %s\n", window_title);
                }
            } else {
                fprintf(stderr, "[DEBUG] No metadata in IR context\n");
            }
        } else {
            fprintf(stderr, "[DEBUG] No IR context found\n");
        }

        fprintf(stderr, "[DEBUG] About to create renderer config with: %dx%d, title='%s'\n", window_width, window_height, window_title);
        fflush(stderr);
        DesktopRendererConfig config = desktop_renderer_config_sdl3(window_width, window_height, window_title);
        fprintf(stderr, "[DEBUG] Created renderer config successfully\n");
        fflush(stderr);

        // Read kryon.toml to determine renderer
        fprintf(stderr, "[DEBUG] Loading config file from current directory\n");
        fflush(stderr);
        KryonConfig* kryon_config = config_find_and_load();
        fprintf(stderr, "[DEBUG] Config loaded: %p\n", (void*)kryon_config);
        fflush(stderr);
        if (kryon_config && kryon_config->desktop_renderer) {
            if (strcmp(kryon_config->desktop_renderer, "raylib") == 0) {
                printf("Renderer: raylib (from kryon.toml)\n");
                config.backend_type = DESKTOP_BACKEND_RAYLIB;
            } else {
                printf("Renderer: sdl3 (from kryon.toml)\n");
                config.backend_type = DESKTOP_BACKEND_SDL3;
            }
            config_free(kryon_config);
        } else {
            printf("Renderer: sdl3 (default)\n");
            config.backend_type = DESKTOP_BACKEND_SDL3;
        }

        // Run the application
        printf("Running application...\n");
        fprintf(stderr, "[DEBUG] About to call desktop_render_ir_component\n");
        fflush(stderr);
        bool success = desktop_render_ir_component(root, &config);
        fprintf(stderr, "[DEBUG] desktop_render_ir_component returned: %d\n", success);

        // Cleanup
        ir_destroy_component(root);

        if (free_target) free((char*)target_file);
        return success ? 0 : 1;
    }

    // Execute KIR files directly
    fprintf(stderr, "[DEBUG] Loading KIR file: %s\n", target_file);
    IRComponent* root = ir_read_json_file(target_file);
    if (!root) {
        fprintf(stderr, "Error: Failed to load KIR file: %s\n", target_file);
        if (free_target) free((char*)target_file);
        return 1;
    }
    fprintf(stderr, "[DEBUG] KIR file loaded successfully\n");

    // Create desktop renderer config with defaults
    int window_width = 800;
    int window_height = 600;
    const char* window_title = "Kryon App";

    // Override with window properties from IR metadata if available
    extern IRContext* g_ir_context;
    fprintf(stderr, "[DEBUG] Checking IR context for window properties\n");
    if (g_ir_context) {
        fprintf(stderr, "[DEBUG] IR context exists\n");
        if (g_ir_context->metadata) {
            fprintf(stderr, "[DEBUG] Metadata exists\n");
            if (g_ir_context->metadata->window_width > 0) {
                window_width = g_ir_context->metadata->window_width;
                fprintf(stderr, "[DEBUG] Using window width: %d\n", window_width);
            }
            if (g_ir_context->metadata->window_height > 0) {
                window_height = g_ir_context->metadata->window_height;
                fprintf(stderr, "[DEBUG] Using window height: %d\n", window_height);
            }
            if (g_ir_context->metadata->window_title) {
                window_title = g_ir_context->metadata->window_title;
                fprintf(stderr, "[DEBUG] Using window title: %s\n", window_title);
            }
        } else {
            fprintf(stderr, "[DEBUG] No metadata in IR context\n");
        }
    } else {
        fprintf(stderr, "[DEBUG] No IR context found\n");
    }

    fprintf(stderr, "[DEBUG] About to create renderer config with: %dx%d, title='%s'\n", window_width, window_height, window_title);
    fflush(stderr);
    DesktopRendererConfig config = desktop_renderer_config_sdl3(window_width, window_height, window_title);
    fprintf(stderr, "[DEBUG] Created renderer config successfully\n");
    fflush(stderr);

    // Read kryon.toml to determine renderer
    fprintf(stderr, "[DEBUG] Loading config file from current directory\n");
    fflush(stderr);
    KryonConfig* kryon_config = config_find_and_load();
    fprintf(stderr, "[DEBUG] Config loaded: %p\n", (void*)kryon_config);
    fflush(stderr);
    if (kryon_config && kryon_config->desktop_renderer) {
        if (strcmp(kryon_config->desktop_renderer, "raylib") == 0) {
            printf("Renderer: raylib (from kryon.toml)\n");
            config.backend_type = DESKTOP_BACKEND_RAYLIB;
        } else {
            printf("Renderer: sdl3 (from kryon.toml)\n");
            config.backend_type = DESKTOP_BACKEND_SDL3;
        }
        config_free(kryon_config);
    } else {
        printf("Renderer: sdl3 (default)\n");
        config.backend_type = DESKTOP_BACKEND_SDL3;
    }

    // Run the application
    printf("Running application...\n");
    bool success = desktop_render_ir_component(root, &config);

    // Cleanup
    ir_destroy_component(root);

    if (free_target) free((char*)target_file);
    return success ? 0 : 1;
}
