# Android/Kotlin Code Generator

Generates idiomatic Kotlin code with Kryon DSL from KIR (Kryon Intermediate Representation) files.

## Pipeline

```
kry → kir → kotlin → android
```

Everything goes through KIR (intermediate representation).

## Features

- ✅ Full KIR → Kotlin DSL conversion
- ✅ AndroidManifest.xml generation
- ✅ build.gradle.kts generation
- ✅ Complete Android project structure
- ✅ Support for all component types:
  - Container
  - Text
  - Button
  - Row
  - Column
  - Image
- ✅ Property translation:
  - Layout: width, height, padding, margin, gap
  - Colors: background, color (text color)
  - Typography: fontSize, fontWeight
  - Borders: border (width, color), cornerRadius
  - Position: position, left, top
  - Alignment: alignItems, justifyContent, textAlign

## Usage

### Command Line

```bash
# Build Android project from KIR file
kryon build app.kir --target android

# Output directory structure:
# ./MainActivity.kt           - Kotlin DSL code
# ./AndroidManifest.xml       - Android manifest
# ./build.gradle.kts          - Gradle build configuration
```

### Programmatic API

```c
#include "codegens/android/ir_android_codegen.h"

// Generate complete Android project
bool ir_generate_android_project(
    const char* kir_path,      // Input KIR file
    const char* output_dir,    // Output directory
    const char* package_name,  // e.g., "com.example.myapp"
    const char* app_name       // e.g., "My App"
);

// Generate only Kotlin code
bool ir_generate_kotlin_code(
    const char* kir_path,
    const char* output_path    // MainActivity.kt
);

// Generate only AndroidManifest.xml
bool ir_generate_android_manifest(
    const char* kir_path,
    const char* output_path,
    const char* app_name
);

// Generate only build.gradle.kts
bool ir_generate_gradle_build(
    const char* kir_path,
    const char* output_path,
    const char* namespace      // Package name
);
```

## Generated Code Structure

### MainActivity.kt

```kotlin
package com.kryon.app

import com.kryon.KryonActivity
import com.kryon.dsl.*

/**
 * Auto-generated Kotlin code from KIR
 * DO NOT EDIT - This file is generated by Kryon
 */
class MainActivity : KryonActivity() {

    override fun buildUI() {
        container {
            background("#1a1a2e")
            text("Hello World") {
                color("yellow")
                fontSize(18.0f)
            }
        }
    }
}
```

### AndroidManifest.xml

```xml
<?xml version="1.0" encoding="utf-8"?>
<manifest xmlns:android="http://schemas.android.com/apk/res/android">
    <application
        android:allowBackup="true"
        android:label="My App"
        android:theme="@style/Theme.Kryon">
        <activity
            android:name=".MainActivity"
            android:exported="true">
            <intent-filter>
                <action android:name="android.intent.action.MAIN" />
                <category android:name="android.intent.category.LAUNCHER" />
            </intent-filter>
        </activity>
    </application>
</manifest>
```

### build.gradle.kts

```kotlin
plugins {
    id("com.android.application")
    id("org.jetbrains.kotlin.android")
}

android {
    namespace = "com.kryon.app"
    compileSdk = 33

    defaultConfig {
        applicationId = "com.kryon.app"
        minSdk = 24
        targetSdk = 33
    }

    compileOptions {
        sourceCompatibility = JavaVersion.VERSION_17
        targetCompatibility = JavaVersion.VERSION_17
    }

    kotlinOptions {
        jvmTarget = "17"
    }
}

dependencies {
    implementation(project(":bindings:kotlin"))
    implementation("androidx.core:core-ktx:1.12.0")
    implementation("androidx.appcompat:appcompat:1.6.1")
}
```

## Kotlin Bindings Library

The generated code depends on the Kotlin bindings library at `bindings/kotlin/`:

- `KryonActivity` - Base activity class with OpenGL ES renderer
- `Container`, `Text`, `Button`, `Row`, `Column`, `Image` - DSL components
- JNI bridge to native Kryon renderer

## Testing

Test files are in `tests/` directory:

```bash
# Run test suite
cd tests
./test_codegen.sh

# Individual tests
./test_codegen.sh button.kir
./test_codegen.sh layout.kir
./test_codegen.sh style.kir
```

## Build System

The codegen uses the standard Kryon build system:

```bash
# Build Android codegen
make -C codegens/android

# Build all codegens
make codegens

# Clean
make -C codegens/android clean
```

## Conservative Toolchain

Uses stable Android toolchain versions for easier migration:

- **compileSdk**: 33
- **targetSdk**: 33
- **minSdk**: 24 (Android 7.0+)
- **AGP**: 7.4.x
- **Kotlin**: 1.9.x
- **JDK**: 17

## Architecture

### KIR Property Mapping

| KIR Property | Kotlin DSL |
|-------------|------------|
| width: "200.0px" | width(200.0f) |
| height: "100.0px" | height(100.0f) |
| background: "#191970" | background("#191970") |
| color: "#ffffff" | color("#ffffff") |
| fontSize: 18.0 | fontSize(18.0f) |
| fontWeight: 700 | fontWeight(700) |
| padding: {top, right, bottom, left} | padding(t, r, b, l) |
| margin: {top, right, bottom, left} | margin(t, r, b, l) |
| gap: 16.0 | gap(16.0f) |
| alignItems: "center" | alignItems("center") |
| justifyContent: "center" | justifyContent("center") |
| position: "absolute" | position("absolute") |
| left: 200 | left(200.0f) |
| top: 100 | top(100.0f) |
| border: {width, color} | border(w, c) |
| cornerRadius: 8.0 | cornerRadius(8.0f) |

## Development

### Adding New Components

1. Add component handler in `ir_android_codegen.c`:

```c
static void generate_mycomponent(KotlinCodegenContext* ctx, cJSON* component) {
    writeln(ctx, "mycomponent {");
    ctx->indent_level++;

    // Generate properties
    cJSON* prop;
    cJSON_ArrayForEach(prop, component) {
        if (strcmp(prop->string, "id") == 0 ||
            strcmp(prop->string, "type") == 0 ||
            strcmp(prop->string, "children") == 0) {
            continue;
        }
        generate_property(ctx, prop->string, prop);
    }

    // Generate children
    cJSON* children = cJSON_GetObjectItem(component, "children");
    if (children && cJSON_IsArray(children)) {
        cJSON* child;
        cJSON_ArrayForEach(child, children) {
            generate_component(ctx, child);
        }
    }

    ctx->indent_level--;
    writeln(ctx, "}");
}
```

2. Add to `generate_component()` switch:

```c
else if (strcmp(component_type, "MyComponent") == 0) {
    generate_mycomponent(ctx, component);
}
```

## Future Enhancements

- [ ] Event handler generation (onClick, etc.)
- [ ] State management integration
- [ ] Multi-file module support
- [ ] Automatic APK building via Gradle
- [ ] ADB install integration
- [ ] Platform layer (OpenGL ES renderer)
- [ ] Native platform initialization

## License

MIT License - See Kryon project license
