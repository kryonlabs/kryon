name: Build and Release Kryon CLI

on:
  push:
    branches: [master]
  workflow_dispatch:

env:
  NIM_VERSION: "2.0.14"
  SDL3_VERSION: "3.2.0"
  SDL3_TTF_VERSION: "3.2.2"

jobs:
  # Job 1: Terminal build - fully static with musl (works on any Linux)
  build-terminal:
    runs-on: ubuntu-latest
    container:
      image: alpine:3.20
    steps:
      - name: Install Alpine dependencies
        run: |
          apk add --no-cache \
            git \
            build-base \
            pkgconf \
            harfbuzz-dev \
            harfbuzz-static \
            freetype-dev \
            freetype-static \
            fribidi-dev \
            fribidi-static \
            bzip2-static \
            libpng-static \
            zlib-static \
            brotli-static \
            nim \
            nimble \
            bash

      - uses: actions/checkout@v4

      - name: Fetch submodules
        run: |
          git config --global --add safe.directory /__w/kryon/kryon
          git submodule update --init --recursive

      - name: Install Nim dependencies
        run: nimble install -y parsetoml cligen

      - name: Build terminal variant (static)
        run: |
          export PATH="$HOME/.nimble/bin:$PATH"
          make -C ir all
          nim c --define:kryonVersion=0.2.0 -d:terminalOnly --opt:size \
            --passL:"-static" \
            --passL:"-Lbuild -lkryon_ir" \
            --passL:"-lharfbuzz -lfreetype -lfribidi -lbz2 -lpng -lz -lbrotlidec -lbrotlicommon" \
            -o:build/kryon-terminal cli/main.nim

      - name: Verify build is static
        run: |
          file build/kryon-terminal
          ./build/kryon-terminal --version

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: kryon-linux-x86_64-terminal
          path: build/kryon-terminal

  # Job 2: Desktop build (needs SDL3) - dynamic linking, glibc-based distros only
  build-desktop:
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install base dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            pkg-config \
            cmake \
            ninja-build \
            libharfbuzz-dev \
            libfreetype6-dev \
            libfribidi-dev \
            libx11-dev \
            libxext-dev \
            libxrandr-dev \
            libxi-dev \
            libgl1-mesa-dev \
            libasound2-dev \
            libpulse-dev

      - name: Cache SDL3
        id: cache-sdl3
        uses: actions/cache@v4
        with:
          path: /usr/local
          key: sdl3-${{ env.SDL3_VERSION }}-ttf-${{ env.SDL3_TTF_VERSION }}-ubuntu-24.04

      - name: Build SDL3 from source
        if: steps.cache-sdl3.outputs.cache-hit != 'true'
        run: |
          git clone --depth 1 --branch release-${{ env.SDL3_VERSION }} \
            https://github.com/libsdl-org/SDL.git /tmp/SDL3
          cd /tmp/SDL3
          cmake -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_INSTALL_PREFIX=/usr/local
          cmake --build build
          sudo cmake --install build

      - name: Build SDL3_ttf from source
        if: steps.cache-sdl3.outputs.cache-hit != 'true'
        run: |
          git clone --depth 1 --branch release-${{ env.SDL3_TTF_VERSION }} \
            https://github.com/libsdl-org/SDL_ttf.git /tmp/SDL3_ttf
          cd /tmp/SDL3_ttf
          cmake -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_INSTALL_PREFIX=/usr/local
          cmake --build build
          sudo cmake --install build

      - name: Update library cache
        run: sudo ldconfig

      - name: Install Nim
        uses: jiro4989/setup-nim-action@v2
        with:
          nim-version: ${{ env.NIM_VERSION }}

      - name: Install Nim dependencies
        run: nimble install -y parsetoml cligen

      - name: Build desktop variant
        run: |
          export PKG_CONFIG_PATH=/usr/local/lib/pkgconfig:$PKG_CONFIG_PATH
          make build-desktop

      - name: Verify build
        run: |
          export LD_LIBRARY_PATH=/usr/local/lib:$LD_LIBRARY_PATH
          ./build/kryon-desktop --version

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: kryon-linux-x86_64-desktop
          path: build/kryon-desktop

  # Job 3: Web build - fully static with musl (works on any Linux)
  build-web:
    runs-on: ubuntu-latest
    container:
      image: alpine:3.20
    steps:
      - name: Install Alpine dependencies
        run: |
          apk add --no-cache \
            git \
            build-base \
            pkgconf \
            harfbuzz-dev \
            harfbuzz-static \
            freetype-dev \
            freetype-static \
            fribidi-dev \
            fribidi-static \
            bzip2-static \
            libpng-static \
            zlib-static \
            brotli-static \
            nim \
            nimble \
            bash

      - uses: actions/checkout@v4

      - name: Fetch submodules
        run: |
          git config --global --add safe.directory /__w/kryon/kryon
          git submodule update --init --recursive

      - name: Install Nim dependencies
        run: nimble install -y parsetoml cligen

      - name: Build web variant (static)
        run: |
          export PATH="$HOME/.nimble/bin:$PATH"
          make -C ir all CC=gcc CFLAGS="-std=c99 -Wall -O2 -fPIC -static"
          nim c --define:kryonVersion=0.2.0 -d:webBackend --opt:size \
            --passL:"-static" \
            --passL:"-Lbuild -lkryon_ir" \
            --passL:"-lharfbuzz -lfreetype -lfribidi -lbz2 -lpng -lz -lbrotlidec -lbrotlicommon" \
            -o:build/kryon-web cli/main.nim

      - name: Verify build is static
        run: |
          file build/kryon-web
          ./build/kryon-web --version

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: kryon-linux-x86_64-web
          path: build/kryon-web

  # Job 4: Create release with all variants
  release:
    needs: [build-terminal, build-desktop, build-web]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4

      - name: Prepare release files
        run: |
          chmod +x kryon-linux-x86_64-terminal/kryon-terminal
          chmod +x kryon-linux-x86_64-desktop/kryon-desktop
          chmod +x kryon-linux-x86_64-web/kryon-web
          mv kryon-linux-x86_64-terminal/kryon-terminal kryon-linux-x86_64-terminal
          mv kryon-linux-x86_64-desktop/kryon-desktop kryon-linux-x86_64-desktop
          mv kryon-linux-x86_64-web/kryon-web kryon-linux-x86_64-web

      - name: Create release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: latest
          name: Latest Build
          prerelease: true
          files: |
            kryon-linux-x86_64-terminal
            kryon-linux-x86_64-desktop
            kryon-linux-x86_64-web
          body: |
            Automated build from master branch.

            **Commit:** ${{ github.sha }}

            ## Available Variants

            | Variant | Static | Works On | Use Case |
            |---------|--------|----------|----------|
            | `kryon-linux-x86_64-terminal` | Yes (musl) | Any Linux | Terminal UI, CI/CD, headless |
            | `kryon-linux-x86_64-desktop` | No (glibc) | Ubuntu, Debian, Fedora, etc. | SDL3 desktop apps |
            | `kryon-linux-x86_64-web` | Yes (musl) | Any Linux | WASM/HTML5 compilation |

            ## Download

            ```bash
            # Terminal-only (static, works everywhere)
            curl -fsSL https://github.com/kryonlabs/kryon/releases/download/latest/kryon-linux-x86_64-terminal -o kryon

            # Desktop (SDL3, requires glibc)
            curl -fsSL https://github.com/kryonlabs/kryon/releases/download/latest/kryon-linux-x86_64-desktop -o kryon

            # Web (static, works everywhere)
            curl -fsSL https://github.com/kryonlabs/kryon/releases/download/latest/kryon-linux-x86_64-web -o kryon

            chmod +x kryon
            ```
