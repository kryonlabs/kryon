#!/usr/bin/env bash

# Kryon Example Runner
# Run examples by number or name
# Usage:
#   ./run_example           - List all examples
#   ./run_example list      - List all examples
#   ./run_example 1         - Run first example (hello_world)
#   ./run_example 16        - Run example #16 (hello_world)
#   ./run_example hello     - Run hello_world example
#   ./run_example 1 terminal - Run with terminal renderer
#   KRYON_RENDERER=terminal ./run_example 1

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Get all examples sorted
EXAMPLES=($(ls examples/nim/*.nim | sort | xargs -n1 basename | sed 's/.nim$//'))
TOTAL=${#EXAMPLES[@]}

# Default renderer
RENDERER="${KRYON_RENDERER:-sdl3}"

# Function to list all examples
list_examples() {
    echo -e "${BLUE}Available Kryon Examples (${TOTAL} total):${NC}"
    echo ""
    for i in "${!EXAMPLES[@]}"; do
        num=$((i + 1))
        name="${EXAMPLES[$i]}"
        printf "  ${GREEN}%2d${NC}. %s\n" "$num" "$name"
    done
    echo ""
    echo -e "${YELLOW}Usage:${NC}"
    echo "  ./run_example <number>       - Run example by number"
    echo "  ./run_example <name>         - Run example by name (without .nim)"
    echo "  ./run_example <num> terminal - Run with terminal renderer"
    echo ""
    echo -e "${YELLOW}Examples:${NC}"
    echo "  ./run_example 1              - Run animations_demo (SDL3)"
    echo "  ./run_example 16             - Run hello_world (SDL3)"
    echo "  ./run_example hello          - Run hello_world (SDL3)"
    echo "  ./run_example 1 terminal     - Run animations_demo (terminal)"
    echo "  KRYON_RENDERER=terminal ./run_example 16"
}

# Function to run an example
run_example() {
    local example_name="$1"
    local renderer="${2:-$RENDERER}"

    local example_file="examples/nim/${example_name}.nim"
    local bin_name="bin/${example_name}"

    if [ ! -f "$example_file" ]; then
        echo -e "${RED}Error: Example '${example_name}' not found${NC}"
        echo ""
        list_examples
        exit 1
    fi

    echo -e "${BLUE}Building: ${example_name}${NC}"
    echo -e "${YELLOW}Renderer: ${renderer}${NC}"
    echo ""

    # Step 1: Compile to .kir (Kryon IR) format using kryon compile
    if [ -x "bin/cli/kryon" ]; then
        echo -e "${BLUE}Step 1: Compiling to IR (.kir)...${NC}"
        mkdir -p build/ir
        bin/cli/kryon compile "$example_file"
        echo -e "${GREEN}✓ IR file saved to build/ir/${NC}"
        echo ""
    elif command -v kryon &> /dev/null; then
        echo -e "${BLUE}Step 1: Compiling to IR (.kir)...${NC}"
        mkdir -p build/ir
        kryon compile "$example_file"
        echo -e "${GREEN}✓ IR file saved to build/ir/${NC}"
        echo ""
    else
        echo -e "${YELLOW}Note: kryon CLI not found, skipping .kir generation${NC}"
        echo -e "${YELLOW}      Build it with: nimble build${NC}"
        echo ""
    fi

    # Step 2: Build the executable
    echo -e "${BLUE}Step 2: Building executable...${NC}"
    if [ "$renderer" = "terminal" ]; then
        nim c -d:KRYON_TERMINAL --path:bindings/nim -o:"$bin_name" "$example_file"
    else
        nim c -d:KRYON_SDL3 --path:bindings/nim -o:"$bin_name" "$example_file"
    fi

    if [ $? -ne 0 ]; then
        echo -e "${RED}Build failed${NC}"
        exit 1
    fi

    echo -e "${GREEN}✓ Executable built: ${bin_name}${NC}"

    echo ""
    echo -e "${GREEN}Running: ${example_name}${NC}"
    echo ""

    # Run the example with proper library path
    env LD_LIBRARY_PATH=build:$LD_LIBRARY_PATH KRYON_RENDERER="$renderer" "$bin_name"
}

# Main script logic
if [ $# -eq 0 ] || [ "$1" = "list" ] || [ "$1" = "-l" ] || [ "$1" = "--list" ]; then
    list_examples
    exit 0
fi

# Get the first argument (number or name)
INPUT="$1"
RENDERER_ARG="${2:-$RENDERER}"

# Check if input is a number
if [[ "$INPUT" =~ ^[0-9]+$ ]]; then
    # Convert 1-based index to 0-based
    INDEX=$((INPUT - 1))

    if [ $INDEX -lt 0 ] || [ $INDEX -ge $TOTAL ]; then
        echo -e "${RED}Error: Invalid example number. Must be between 1 and ${TOTAL}${NC}"
        echo ""
        list_examples
        exit 1
    fi

    EXAMPLE_NAME="${EXAMPLES[$INDEX]}"
else
    # Input is a name - find it or match partial
    EXAMPLE_NAME=""

    # First try exact match
    for ex in "${EXAMPLES[@]}"; do
        if [ "$ex" = "$INPUT" ]; then
            EXAMPLE_NAME="$ex"
            break
        fi
    done

    # If no exact match, try partial match
    if [ -z "$EXAMPLE_NAME" ]; then
        MATCHES=()
        for ex in "${EXAMPLES[@]}"; do
            if [[ "$ex" == *"$INPUT"* ]]; then
                MATCHES+=("$ex")
            fi
        done

        if [ ${#MATCHES[@]} -eq 0 ]; then
            echo -e "${RED}Error: No example matching '${INPUT}' found${NC}"
            echo ""
            list_examples
            exit 1
        elif [ ${#MATCHES[@]} -eq 1 ]; then
            EXAMPLE_NAME="${MATCHES[0]}"
            echo -e "${YELLOW}Matched: ${EXAMPLE_NAME}${NC}"
        else
            echo -e "${RED}Error: Multiple matches found for '${INPUT}':${NC}"
            for m in "${MATCHES[@]}"; do
                echo "  - $m"
            done
            echo ""
            echo "Please be more specific."
            exit 1
        fi
    fi
fi

# Run the example
run_example "$EXAMPLE_NAME" "$RENDERER_ARG"
