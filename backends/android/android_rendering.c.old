/*
 * Android Component Rendering - IR to AndroidRenderer
 *
 * Renders IR components using the AndroidRenderer low-level API.
 */

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <math.h>
#include "android_internal.h"

// ============================================================================
// HELPER FUNCTIONS
// ============================================================================

static uint32_t ir_color_to_rgba(IRColor color, float opacity) {
    uint8_t a = (uint8_t)(color.a * opacity);
    uint8_t r = color.r;
    uint8_t g = color.g;
    uint8_t b = color.b;
    return (a << 24) | (r << 16) | (g << 8) | b;
}

static void render_background(AndroidRenderer* renderer,
                              IRComponent* component,
                              float x, float y,
                              float width, float height,
                              float opacity) {
    if (!component->style) return;

    IRColor bg_color = component->style->background_color;
    float radius = component->style->border_radius;

    // Skip fully transparent backgrounds
    if (bg_color.a == 0) return;

    uint32_t color = ir_color_to_rgba(bg_color, opacity);

    if (radius > 0) {
        android_renderer_draw_rounded_rect(renderer, x, y, width, height,
                                           radius, color);
    } else {
        android_renderer_draw_rect(renderer, x, y, width, height, color);
    }
}

static void render_box_shadow(AndroidRenderer* renderer,
                              IRComponent* component,
                              float x, float y,
                              float width, float height,
                              float opacity) {
    if (!component->style || !component->style->shadow) return;

    IRBoxShadow* shadow = component->style->shadow;
    uint32_t shadow_color = ir_color_to_rgba(shadow->color, opacity);
    float radius = component->style->border_radius;

    android_renderer_draw_box_shadow(renderer,
                                     x, y, width, height,
                                     radius,
                                     shadow->offset_x,
                                     shadow->offset_y,
                                     shadow->blur_radius,
                                     shadow_color);
}

static void render_border(AndroidRenderer* renderer,
                         IRComponent* component,
                         float x, float y,
                         float width, float height,
                         float opacity) {
    if (!component->style) return;

    float border_width = component->style->border.width;
    if (border_width <= 0) return;

    uint32_t border_color = ir_color_to_rgba(component->style->border.color,
                                             opacity);

    android_renderer_draw_rect_outline(renderer, x, y, width, height,
                                       border_width, border_color);
}

// ============================================================================
// COMPONENT RENDERING
// ============================================================================

void render_component_android(AndroidIRRenderer* ir_renderer,
                              IRComponent* component,
                              float parent_x, float parent_y,
                              float parent_opacity) {
    if (!ir_renderer || !component || !ir_renderer->renderer) return;

    AndroidRenderer* renderer = ir_renderer->renderer;

    // Calculate absolute position
    float x = parent_x + component->rendered_bounds.x;
    float y = parent_y + component->rendered_bounds.y;
    float width = component->rendered_bounds.width;
    float height = component->rendered_bounds.height;

    // Calculate effective opacity
    float opacity = parent_opacity;
    if (component->style) {
        opacity *= component->style->opacity;
    }

    // Skip fully transparent components
    if (opacity <= 0.0f) return;

    // Set global opacity
    android_renderer_set_opacity(renderer, opacity);

    // TODO: Box shadow rendering not yet implemented
    // if (component->style && component->style->shadow) {
    //     render_box_shadow(renderer, component, x, y, width, height, opacity);
    // }

    // Render component based on type
    switch (component->type) {
        case IR_COMPONENT_CONTAINER:
        case IR_COMPONENT_ROW:
        case IR_COMPONENT_COLUMN:
            // Render background
            render_background(renderer, component, x, y, width, height, opacity);

            // Render border
            render_border(renderer, component, x, y, width, height, opacity);
            break;

        case IR_COMPONENT_CENTER:
            // Center is layout-only, no visual rendering
            break;

        case IR_COMPONENT_BUTTON: {
            // Render button background
            render_background(renderer, component, x, y, width, height, opacity);

            // Render border
            render_border(renderer, component, x, y, width, height, opacity);

            // Render button text
            if (component->text_content) {
                IRColor text_color = component->style ?
                    component->style->font.color :
                    IR_COLOR_RGBA(0, 0, 0, 255);

                int font_size = component->style && component->style->font.size > 0 ?
                    (int)component->style->font.size : 16;

                uint32_t color = ir_color_to_rgba(text_color, opacity);

                // Measure text to center it
                float text_width, text_height;
                android_renderer_measure_text(renderer, component->text_content,
                                             NULL, font_size,
                                             &text_width, &text_height);

                float text_x = x + (width - text_width) / 2.0f;
                float text_y = y + (height - text_height) / 2.0f;

                android_renderer_draw_text(renderer, component->text_content,
                                          text_x, text_y,
                                          NULL, font_size, color);
            }
            break;
        }

        case IR_COMPONENT_TEXT: {
            if (component->text_content) {
                IRColor text_color = component->style ?
                    component->style->font.color :
                    IR_COLOR_RGBA(0, 0, 0, 255);

                int font_size = component->style && component->style->font.size > 0 ?
                    (int)component->style->font.size : 16;

                uint32_t color = ir_color_to_rgba(text_color, opacity);

                android_renderer_draw_text(renderer, component->text_content,
                                          x, y, NULL, font_size, color);
            }
            break;
        }

        case IR_COMPONENT_INPUT: {
            // Render input background
            render_background(renderer, component, x, y, width, height, opacity);

            // Render border
            render_border(renderer, component, x, y, width, height, opacity);

            // Render input text (using text_content for now)
            const char* text = component->text_content ? component->text_content : "";

            if (text && text[0]) {
                IRColor text_color = component->style ?
                    component->style->font.color :
                    IR_COLOR_RGBA(0, 0, 0, 255);

                int font_size = component->style && component->style->font.size > 0 ?
                    (int)component->style->font.size : 16;

                uint32_t color = ir_color_to_rgba(text_color, opacity);

                android_renderer_draw_text(renderer, text,
                                          x + 8, y + 8,
                                          NULL, font_size, color);
            }
            break;
        }

        case IR_COMPONENT_CHECKBOX: {
            // Render checkbox box
            render_background(renderer, component, x, y, width, height, opacity);
            render_border(renderer, component, x, y, width, height, opacity);

            // TODO: Checkbox state handling needs to be implemented
            // For now just render the box
            break;
        }

        case IR_COMPONENT_IMAGE: {
            if (component->image_data && component->image_data->path) {
                // Load and render image
                int img_w, img_h;
                GLuint texture = android_renderer_load_texture_from_file(
                    renderer, component->image_data->path, &img_w, &img_h);

                if (texture) {
                    android_renderer_draw_texture(renderer, texture,
                                                 x, y, width, height,
                                                 0xFFFFFFFF);
                }
            }
            break;
        }

        case IR_COMPONENT_CANVAS: {
            // Render canvas background
            render_background(renderer, component, x, y, width, height, opacity);

            // TODO: Render canvas drawing commands
            break;
        }

        default:
            break;
    }

    // Render children
    if (component->children) {
        for (int i = 0; i < component->children_count; i++) {
            render_component_android(ir_renderer,
                                    &component->children[i],
                                    x, y, opacity);
        }
    }

    // Reset opacity
    android_renderer_reset_opacity(renderer);
}
