name: Build and Release Kryon CLI

on:
  push:
    branches: [master]
  workflow_dispatch:

env:
  NIM_VERSION: "2.0.14"
  SDL3_VERSION: "3.2.6"
  SDL3_TTF_VERSION: "3.2.2"

jobs:
  # Job 1: Terminal build - fully static with musl (works on any Linux)
  build-terminal:
    runs-on: ubuntu-latest
    container:
      image: alpine:3.20
    steps:
      - name: Install Alpine dependencies
        run: |
          apk add --no-cache \
            git \
            build-base \
            pkgconf \
            harfbuzz-dev \
            harfbuzz-static \
            freetype-dev \
            freetype-static \
            fribidi-dev \
            fribidi-static \
            graphite2-dev \
            graphite2-static \
            bzip2-static \
            libpng-static \
            zlib-static \
            brotli-static \
            nim \
            nimble \
            bash

      - uses: actions/checkout@v4

      - name: Fetch submodules
        run: |
          git config --global --add safe.directory /__w/kryon/kryon
          git submodule update --init --recursive

      - name: Install Nim dependencies
        run: nimble install -y parsetoml cligen

      - name: Build terminal variant (static)
        run: |
          export PATH="$HOME/.nimble/bin:$PATH"
          make -C ir all
          nim c --define:kryonVersion=0.2.0 -d:terminalOnly --opt:size \
            --passL:"-static" \
            --passL:"-Lbuild -lkryon_ir" \
            --passL:"-lharfbuzz -lgraphite2 -lfreetype -lfribidi -lbz2 -lpng -lz -lbrotlidec -lbrotlicommon" \
            -o:build/kryon-terminal cli/main.nim

      - name: Verify build is static
        run: |
          file build/kryon-terminal
          ./build/kryon-terminal --version

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: kryon-linux-x86_64-terminal
          path: build/kryon-terminal

  # Job 2: Desktop build (needs SDL3) - dynamic linking, glibc-based distros only
  build-desktop:
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install base dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            pkg-config \
            cmake \
            ninja-build \
            libharfbuzz-dev \
            libfreetype6-dev \
            libfribidi-dev \
            libx11-dev \
            libxext-dev \
            libxrandr-dev \
            libxi-dev \
            libgl1-mesa-dev \
            libasound2-dev \
            libpulse-dev

      - name: Cache SDL3
        id: cache-sdl3
        uses: actions/cache@v4
        with:
          path: /usr/local
          key: sdl3-${{ env.SDL3_VERSION }}-ttf-${{ env.SDL3_TTF_VERSION }}-ubuntu-24.04

      - name: Build SDL3 from source
        if: steps.cache-sdl3.outputs.cache-hit != 'true'
        run: |
          git clone --depth 1 --branch release-${{ env.SDL3_VERSION }} \
            https://github.com/libsdl-org/SDL.git /tmp/SDL3
          cd /tmp/SDL3
          cmake -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_INSTALL_PREFIX=/usr/local
          cmake --build build
          sudo cmake --install build

      - name: Build SDL3_ttf from source
        if: steps.cache-sdl3.outputs.cache-hit != 'true'
        run: |
          git clone --depth 1 --branch release-${{ env.SDL3_TTF_VERSION }} \
            https://github.com/libsdl-org/SDL_ttf.git /tmp/SDL3_ttf
          cd /tmp/SDL3_ttf
          cmake -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_INSTALL_PREFIX=/usr/local
          cmake --build build
          sudo cmake --install build

      - name: Update library cache
        run: sudo ldconfig

      - name: Install Nim
        uses: jiro4989/setup-nim-action@v2
        with:
          nim-version: ${{ env.NIM_VERSION }}

      - name: Install Nim dependencies
        run: nimble install -y parsetoml cligen

      - name: Build desktop variant with RPATH
        run: |
          export PKG_CONFIG_PATH=/usr/local/lib/pkgconfig:$PKG_CONFIG_PATH
          # Build C libraries (static and shared)
          make -C ir all
          make -C backends/desktop all
          # Build CLI with RPATH set to find libs in ./lib relative to binary
          nim c --define:kryonVersion=0.2.0 -d:desktopBackend --opt:speed \
            --passL:"-Wl,-rpath,'\$ORIGIN/lib'" \
            --passL:"-Lbuild -lkryon_ir -lkryon_desktop $(pkg-config --libs sdl3 SDL3_ttf)" \
            -o:build/kryon-desktop cli/main.nim

      - name: Verify build
        run: |
          export LD_LIBRARY_PATH=/usr/local/lib:build:$LD_LIBRARY_PATH
          ./build/kryon-desktop --version

      - name: Create bundle with shared libraries
        run: |
          mkdir -p bundle/lib
          cp build/kryon-desktop bundle/kryon
          # Copy Kryon shared libraries
          cp build/libkryon_ir.so bundle/lib/ || echo "libkryon_ir.so not found"
          cp build/libkryon_desktop.so bundle/lib/ || echo "libkryon_desktop.so not found"
          # Copy SDL3 libraries (follow symlinks to get real files)
          cp -L /usr/local/lib/libSDL3.so.0 bundle/lib/
          cp -L /usr/local/lib/libSDL3_ttf.so.0 bundle/lib/
          # Create symlinks for library loading
          ln -sf libSDL3.so.0 bundle/lib/libSDL3.so
          ln -sf libSDL3_ttf.so.0 bundle/lib/libSDL3_ttf.so
          # Show bundle contents
          ls -la bundle/ bundle/lib/
          # Create tarball
          tar -czvf kryon-desktop-bundle.tar.gz -C bundle .
          ls -la kryon-desktop-bundle.tar.gz

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: kryon-linux-x86_64-desktop
          path: kryon-desktop-bundle.tar.gz

  # Job 3: Web build - fully static with musl (works on any Linux)
  build-web:
    runs-on: ubuntu-latest
    container:
      image: alpine:3.20
    steps:
      - name: Install Alpine dependencies
        run: |
          apk add --no-cache \
            git \
            build-base \
            pkgconf \
            harfbuzz-dev \
            harfbuzz-static \
            freetype-dev \
            freetype-static \
            fribidi-dev \
            fribidi-static \
            graphite2-dev \
            graphite2-static \
            bzip2-static \
            libpng-static \
            zlib-static \
            brotli-static \
            nim \
            nimble \
            bash

      - uses: actions/checkout@v4

      - name: Fetch submodules
        run: |
          git config --global --add safe.directory /__w/kryon/kryon
          git submodule update --init --recursive

      - name: Install Nim dependencies
        run: nimble install -y parsetoml cligen

      - name: Build web variant (static)
        run: |
          export PATH="$HOME/.nimble/bin:$PATH"
          make -C ir all
          make -C backends/web all
          nim c --define:kryonVersion=0.2.0 -d:webBackend --opt:size \
            --passL:"-static" \
            --passL:"-Lbuild -lkryon_ir -lkryon_web" \
            --passL:"-lharfbuzz -lgraphite2 -lfreetype -lfribidi -lbz2 -lpng -lz -lbrotlidec -lbrotlicommon" \
            -o:build/kryon-web cli/main.nim

      - name: Verify build is static
        run: |
          file build/kryon-web
          ./build/kryon-web --version

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: kryon-linux-x86_64-web
          path: build/kryon-web

  # Job 4: Default build (all backends) - dynamic linking, glibc-based
  build-default:
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install base dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            pkg-config \
            cmake \
            ninja-build \
            libharfbuzz-dev \
            libfreetype6-dev \
            libfribidi-dev \
            libx11-dev \
            libxext-dev \
            libxrandr-dev \
            libxi-dev \
            libgl1-mesa-dev \
            libasound2-dev \
            libpulse-dev

      - name: Cache SDL3
        id: cache-sdl3
        uses: actions/cache@v4
        with:
          path: /usr/local
          key: sdl3-${{ env.SDL3_VERSION }}-ttf-${{ env.SDL3_TTF_VERSION }}-ubuntu-24.04

      - name: Build SDL3 from source
        if: steps.cache-sdl3.outputs.cache-hit != 'true'
        run: |
          git clone --depth 1 --branch release-${{ env.SDL3_VERSION }} \
            https://github.com/libsdl-org/SDL.git /tmp/SDL3
          cd /tmp/SDL3
          cmake -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_INSTALL_PREFIX=/usr/local
          cmake --build build
          sudo cmake --install build

      - name: Build SDL3_ttf from source
        if: steps.cache-sdl3.outputs.cache-hit != 'true'
        run: |
          git clone --depth 1 --branch release-${{ env.SDL3_TTF_VERSION }} \
            https://github.com/libsdl-org/SDL_ttf.git /tmp/SDL3_ttf
          cd /tmp/SDL3_ttf
          cmake -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_INSTALL_PREFIX=/usr/local
          cmake --build build
          sudo cmake --install build

      - name: Update library cache
        run: sudo ldconfig

      - name: Install Nim
        uses: jiro4989/setup-nim-action@v2
        with:
          nim-version: ${{ env.NIM_VERSION }}

      - name: Install Nim dependencies
        run: nimble install -y parsetoml cligen

      - name: Build default variant with RPATH (all backends)
        run: |
          export PKG_CONFIG_PATH=/usr/local/lib/pkgconfig:$PKG_CONFIG_PATH
          # Build C libraries (static and shared)
          make -C ir all
          make -C backends/desktop all
          make -C backends/web all
          # Build CLI with RPATH set to find libs in ./lib relative to binary
          nim c --define:kryonVersion=0.2.0 -d:staticBackend --opt:speed \
            --passL:"-Wl,-rpath,'\$ORIGIN/lib'" \
            --passL:"-Lbuild -lkryon_ir -lkryon_desktop -lkryon_web $(pkg-config --libs sdl3 SDL3_ttf)" \
            -o:build/kryon-full cli/main.nim

      - name: Verify build
        run: |
          export LD_LIBRARY_PATH=/usr/local/lib:build:$LD_LIBRARY_PATH
          ./build/kryon-full --version

      - name: Create bundle with shared libraries
        run: |
          mkdir -p bundle/lib
          cp build/kryon-full bundle/kryon
          # Copy Kryon shared libraries
          cp build/libkryon_ir.so bundle/lib/ || echo "libkryon_ir.so not found"
          cp build/libkryon_desktop.so bundle/lib/ || echo "libkryon_desktop.so not found"
          cp build/libkryon_web.so bundle/lib/ || echo "libkryon_web.so not found"
          # Copy SDL3 libraries (follow symlinks to get real files)
          cp -L /usr/local/lib/libSDL3.so.0 bundle/lib/
          cp -L /usr/local/lib/libSDL3_ttf.so.0 bundle/lib/
          # Create symlinks for library loading
          ln -sf libSDL3.so.0 bundle/lib/libSDL3.so
          ln -sf libSDL3_ttf.so.0 bundle/lib/libSDL3_ttf.so
          # Show bundle contents
          ls -la bundle/ bundle/lib/
          # Create tarball
          tar -czvf kryon-bundle.tar.gz -C bundle .
          ls -la kryon-bundle.tar.gz

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: kryon-linux-x86_64
          path: kryon-bundle.tar.gz

  # Job 5: Create release with all variants
  release:
    needs: [build-terminal, build-desktop, build-web, build-default]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4

      - name: Prepare release files
        run: |
          ls -la
          ls -la kryon-linux-x86_64-terminal/ kryon-linux-x86_64-desktop/ kryon-linux-x86_64-web/ kryon-linux-x86_64/

          # Static builds - extract from artifact directories
          # (artifact directories have same name as desired output files)
          chmod +x kryon-linux-x86_64-terminal/kryon-terminal
          chmod +x kryon-linux-x86_64-web/kryon-web
          cp kryon-linux-x86_64-terminal/kryon-terminal ./kryon-terminal-static
          cp kryon-linux-x86_64-web/kryon-web ./kryon-web-static
          rm -rf kryon-linux-x86_64-terminal kryon-linux-x86_64-web
          mv ./kryon-terminal-static ./kryon-linux-x86_64-terminal
          mv ./kryon-web-static ./kryon-linux-x86_64-web

          # Bundled builds - already tarballs, just rename
          mv kryon-linux-x86_64-desktop/kryon-desktop-bundle.tar.gz kryon-linux-x86_64-desktop.tar.gz
          mv kryon-linux-x86_64/kryon-bundle.tar.gz kryon-linux-x86_64.tar.gz

          ls -la

      - name: Create release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: latest
          name: Latest Build
          prerelease: true
          files: |
            kryon-linux-x86_64.tar.gz
            kryon-linux-x86_64-terminal
            kryon-linux-x86_64-desktop.tar.gz
            kryon-linux-x86_64-web
          body: |
            Automated build from master branch.

            **Commit:** ${{ github.sha }}

            ## Available Variants

            | Variant | Format | Works On | Use Case |
            |---------|--------|----------|----------|
            | `kryon-linux-x86_64.tar.gz` | Bundle | Any Linux (glibc) | Full CLI with all backends |
            | `kryon-linux-x86_64-terminal` | Static | Any Linux | Terminal UI, CI/CD, headless |
            | `kryon-linux-x86_64-desktop.tar.gz` | Bundle | Any Linux (glibc) | SDL3 desktop apps |
            | `kryon-linux-x86_64-web` | Static | Any Linux | Website generation (HTML/CSS/JS) |

            ## Download & Install

            ### Full CLI (recommended)
            ```bash
            curl -fsSL https://github.com/kryonlabs/kryon/releases/download/latest/kryon-linux-x86_64.tar.gz | tar xz
            ./kryon --version
            # Or install to PATH:
            sudo mv kryon /usr/local/bin/
            sudo mv lib/* /usr/local/lib/
            sudo ldconfig
            ```

            ### Terminal-only (static, works everywhere)
            ```bash
            curl -fsSL https://github.com/kryonlabs/kryon/releases/download/latest/kryon-linux-x86_64-terminal -o kryon
            chmod +x kryon
            ```

            ### Desktop (SDL3 apps)
            ```bash
            curl -fsSL https://github.com/kryonlabs/kryon/releases/download/latest/kryon-linux-x86_64-desktop.tar.gz | tar xz
            ./kryon --version
            ```

            ### Web (HTML/CSS/JS generation, static)
            ```bash
            curl -fsSL https://github.com/kryonlabs/kryon/releases/download/latest/kryon-linux-x86_64-web -o kryon
            chmod +x kryon
            ```
