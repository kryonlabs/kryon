<!DOCTYPE html>
<html>
<head>
    <title>Kryon Event Dispatch Test</title>
    <style>
        body { font-family: sans-serif; padding: 20px; background: #1a1a2e; color: #eee; }
        .test { margin: 10px 0; padding: 10px; border-radius: 5px; }
        .pass { background: #1e4620; }
        .fail { background: #4a1e1e; }
        .pending { background: #3d3d00; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; }
        pre { background: #222; padding: 10px; overflow-x: auto; }
        #log { max-height: 300px; overflow-y: auto; }
    </style>
    <script src="../vendor/fengari-web.min.js"></script>
</head>
<body>
    <h1>Kryon Event Dispatch Test</h1>

    <h2>Test Results</h2>
    <div id="results"></div>

    <h2>Manual Tests</h2>
    <button onclick="testBasicDispatch()">Test Basic Dispatch</button>
    <button onclick="testHandlerRegistration()">Test Handler Registration</button>
    <button onclick="testEventIdMapping()">Test Event ID Mapping</button>

    <h2>Console Log</h2>
    <pre id="log"></pre>

    <!-- Lua test code -->
    <script type="application/lua">
        local js = require("js")
        local window = js.global

        -- Capture print output
        local oldPrint = print
        print = function(...)
            oldPrint(...)
            local args = {...}
            local str = ""
            for i, v in ipairs(args) do
                str = str .. tostring(v) .. "\t"
            end
            local logDiv = window.document:getElementById("log")
            if logDiv then
                logDiv.textContent = logDiv.textContent .. str .. "\n"
            end
        end

        print("[Lua] Fengari initialized")

        -- Test state
        window.lua_test_state = {
            dispatch_received = false,
            dispatch_id = 0,
            handlers = {},
            handler_call_count = 0
        }

        -- Simple dispatch handler
        window.kryon_lua_dispatch = function(this, handlerId)
            print("[Lua] kryon_lua_dispatch called with: " .. tostring(handlerId))
            window.lua_test_state.dispatch_received = true
            window.lua_test_state.dispatch_id = handlerId

            -- Call registered handler if exists
            local handler = window.lua_test_state.handlers[handlerId]
            if handler then
                print("[Lua] Found handler for ID " .. handlerId .. ", calling...")
                local ok, err = pcall(handler)
                if ok then
                    window.lua_test_state.handler_call_count = window.lua_test_state.handler_call_count + 1
                    print("[Lua] Handler executed successfully")
                else
                    print("[Lua] Handler error: " .. tostring(err))
                end
            else
                print("[Lua] No handler found for ID: " .. handlerId)
            end
        end

        -- Register handler function
        window.lua_register_handler = function(this, id, callback)
            print("[Lua] Registering handler for ID: " .. tostring(id))
            window.lua_test_state.handlers[id] = callback
        end

        -- Test with event ID mapping (simulating __KRYON_EVENT_IDS__)
        window.lua_test_event_mapping = function(this)
            local event_ids = {1, 2, 48, 49, 50}
            print("[Lua] Testing event ID mapping: " .. table.concat(event_ids, ", "))

            -- Register handlers using mapped IDs (like dsl_web.lua does)
            for i, event_id in ipairs(event_ids) do
                window.lua_test_state.handlers[event_id] = function()
                    print("[Lua] Handler " .. i .. " (event_id=" .. event_id .. ") called!")
                end
            end

            return true
        end

        print("[Lua] Test functions registered")
    </script>

    <script>
        const results = document.getElementById('results');
        const log = document.getElementById('log');

        function addResult(name, passed, message) {
            const div = document.createElement('div');
            div.className = 'test ' + (passed ? 'pass' : 'fail');
            div.innerHTML = `<strong>${passed ? 'PASS' : 'FAIL'}:</strong> ${name}<br><small>${message}</small>`;
            results.appendChild(div);
        }

        function logMessage(msg) {
            log.textContent += msg + '\n';
            log.scrollTop = log.scrollHeight;
        }

        // Test 1: Basic dispatch
        function testBasicDispatch() {
            logMessage('[JS] Testing basic dispatch...');

            if (typeof window.kryon_lua_dispatch !== 'function') {
                addResult('Basic Dispatch', false, 'kryon_lua_dispatch is not a function');
                return;
            }

            // Reset state
            window.lua_test_state.dispatch_received = false;
            window.lua_test_state.dispatch_id = 0;

            // Dispatch
            window.kryon_lua_dispatch(42);

            // Check result
            setTimeout(() => {
                const received = window.lua_test_state.dispatch_received;
                const id = window.lua_test_state.dispatch_id;
                addResult('Basic Dispatch', received && id === 42,
                    `received=${received}, id=${id}`);
            }, 100);
        }

        // Test 2: Handler registration and callback
        function testHandlerRegistration() {
            logMessage('[JS] Testing handler registration...');

            // Register a handler from JS side
            const testId = 99;
            window.lua_register_handler(testId, function() {
                logMessage('[Lua-callback] Handler 99 executed!');
            });

            // Dispatch to it
            window.lua_test_state.handler_call_count = 0;
            window.kryon_lua_dispatch(testId);

            setTimeout(() => {
                const count = window.lua_test_state.handler_call_count;
                addResult('Handler Registration', count > 0,
                    `handler_call_count=${count}`);
            }, 100);
        }

        // Test 3: Event ID mapping (like __KRYON_EVENT_IDS__)
        function testEventIdMapping() {
            logMessage('[JS] Testing event ID mapping...');

            // Set up mapped handlers
            window.lua_test_event_mapping();

            // Test dispatching to mapped IDs
            window.lua_test_state.handler_call_count = 0;

            // Dispatch to event_id 48 (which should be handler index 3)
            window.kryon_lua_dispatch(48);

            setTimeout(() => {
                const count = window.lua_test_state.handler_call_count;
                addResult('Event ID Mapping', count > 0,
                    `Dispatched to ID 48, handler_call_count=${count}`);
            }, 100);
        }

        // Run initial tests after Fengari loads
        setTimeout(() => {
            logMessage('[JS] Running initial tests...');

            // Check Fengari loaded
            if (typeof window.kryon_lua_dispatch === 'function') {
                addResult('Fengari Load', true, 'kryon_lua_dispatch is available');
            } else {
                addResult('Fengari Load', false, 'kryon_lua_dispatch not found');
            }
        }, 500);
    </script>
</body>
</html>
