/**
 * Run Command
 * Executes source files or KIR files using C backend
 */

#include "kryon_cli.h"
#include <stdio.h>
#include <stdlib.h>
#include <string.h>

static const char* detect_frontend(const char* file) {
    const char* ext = path_extension(file);

    if (strcmp(ext, ".kry") == 0) return "kry";
    else if (strcmp(ext, ".kir") == 0) return "kir";
    else if (strcmp(ext, ".md") == 0) return "markdown";
    else if (strcmp(ext, ".html") == 0) return "html";
    else if (strcmp(ext, ".tsx") == 0 || strcmp(ext, ".jsx") == 0) return "tsx";
    else if (strcmp(ext, ".c") == 0 || strcmp(ext, ".h") == 0) return "c";
    else return NULL;
}

int cmd_run(int argc, char** argv) {
    const char* target_file = NULL;
    bool free_target = false;

    // If no file specified, use entry from config
    if (argc < 1) {
        KryonConfig* config = config_find_and_load();
        if (!config) {
            fprintf(stderr, "Error: No file specified and no kryon.toml found\n\n");
            fprintf(stderr, "Usage: kryon run <file>\n\n");
            fprintf(stderr, "Supported file types:\n");
            fprintf(stderr, "  .kry        - Kryon DSL\n");
            fprintf(stderr, "  .kir        - Kryon IR (compiled)\n");
            fprintf(stderr, "  .md         - Markdown documents\n");
            fprintf(stderr, "  .tsx, .jsx  - TypeScript/JavaScript with JSX\n");
            return 1;
        }

        if (!config->build_entry) {
            fprintf(stderr, "Error: No file specified and no build.entry in kryon.toml\n\n");
            fprintf(stderr, "Add to your kryon.toml:\n");
            fprintf(stderr, "  [build]\n");
            fprintf(stderr, "  entry = \"your-file.kry\"\n\n");
            fprintf(stderr, "Or run with a file:\n");
            fprintf(stderr, "  kryon run <file>\n");
            config_free(config);
            return 1;
        }

        target_file = str_copy(config->build_entry);
        free_target = true;
        config_free(config);
    } else {
        target_file = argv[0];
    }

    // Check if file exists
    if (!file_exists(target_file)) {
        fprintf(stderr, "Error: File not found: %s\n", target_file);
        if (free_target) free((char*)target_file);
        return 1;
    }

    // Detect frontend and validate BEFORE printing "Running"
    const char* frontend = detect_frontend(target_file);
    if (!frontend) {
        const char* ext = path_extension(target_file);
        fprintf(stderr, "Error: Unsupported file type: %s\n\n", ext);
        fprintf(stderr, "Supported INPUT formats:\n");
        fprintf(stderr, "  .kry        - Kryon DSL\n");
        fprintf(stderr, "  .kir        - Kryon IR (compiled)\n");
        fprintf(stderr, "  .md         - Markdown documents\n");
        fprintf(stderr, "  .html       - HTML documents\n");
        fprintf(stderr, "  .tsx, .jsx  - TypeScript/JavaScript with JSX\n");
        fprintf(stderr, "  .c, .h      - C source with Kryon API\n");
        fprintf(stderr, "\nNote: .nim and .lua are OUTPUT formats (generated by codegen)\n");
        fprintf(stderr, "Use: kryon codegen <lang> <input.kir> <output>\n");
        if (free_target) free((char*)target_file);
        return 1;
    }

    printf("Running: %s\n", target_file);

    // Get the path to the desktop renderer library
    const char* desktop_lib = getenv("KRYON_DESKTOP_LIB");
    if (!desktop_lib) {
        // Try default locations
        if (file_exists("/home/wao/.local/lib/libkryon_desktop.so")) {
            desktop_lib = "/home/wao/.local/lib/libkryon_desktop.so";
        } else if (file_exists("/mnt/storage/Projects/kryon/build/libkryon_desktop.so")) {
            desktop_lib = "/mnt/storage/Projects/kryon/build/libkryon_desktop.so";
        } else {
            fprintf(stderr, "Error: Desktop renderer library not found\n");
            fprintf(stderr, "Please run: make install\n");
            fprintf(stderr, "Or set KRYON_DESKTOP_LIB environment variable\n");
            if (free_target) free((char*)target_file);
            return 1;
        }
    }

    // Build command to run the file
    char cmd[4096];

    if (strcmp(frontend, "kir") == 0) {
        // Run KIR file directly
        snprintf(cmd, sizeof(cmd),
                 "LD_LIBRARY_PATH=/home/wao/.local/lib:\"/mnt/storage/Projects/kryon/build\":$LD_LIBRARY_PATH "
                 "KRYON_LIB_PATH=\"%s\" "
                 "%s \"%s\"",
                 desktop_lib, desktop_lib, target_file);
    } else {
        // AUTO-COMPILE ANY FORMAT TO KIR FIRST

        // Extract basename from target_file
        const char* basename = strrchr(target_file, '/');
        basename = basename ? basename + 1 : target_file;

        // Create KIR filename
        char kir_file[1024];
        snprintf(kir_file, sizeof(kir_file), ".kryon_cache/%s", basename);

        // Change extension to .kir
        char* dot = strrchr(kir_file, '.');
        if (dot) {
            strcpy(dot, ".kir");
        }

        // Compile to KIR (works for ALL formats now: .kry, .md, .html, .tsx, .nim, .lua, .c)
        printf("Compiling %s...\n", target_file);
        char compile_cmd[2048];
        snprintf(compile_cmd, sizeof(compile_cmd),
                 "kryon compile \"%s\" 2>&1", target_file);

        int compile_result = system(compile_cmd);
        if (compile_result != 0) {
            fprintf(stderr, "Error: Failed to compile %s\n", target_file);
            if (free_target) free((char*)target_file);
            return 1;
        }

        // Run the KIR
        snprintf(cmd, sizeof(cmd),
                 "LD_LIBRARY_PATH=/home/wao/.local/lib:\"/mnt/storage/Projects/kryon/build\":$LD_LIBRARY_PATH "
                 "KRYON_LIB_PATH=\"%s\" "
                 "%s \"%s\"",
                 desktop_lib, desktop_lib, kir_file);
    }

    // Execute
    if (getenv("KRYON_VERBOSE")) {
        printf("[kryon run] Executing: %s\n", cmd);
    }

    int result = system(cmd);

    if (free_target) free((char*)target_file);
    return result;
}
